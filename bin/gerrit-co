#!/bin/bash

if [[ -z "$GERRIT_URL" ]]; then
  echo 'The variable $GERRIT_URL must be set'
  exit 1
fi
QUERY=$(echo "$1" | tr " " "+")
QUERY_FIELDS="o=CURRENT_REVISION&o=CURRENT_COMMIT&o=CURRENT_FILES&o=DOWNLOAD_COMMANDS"
CHECKOUT_METHOD="ssh"

# there can only be one / between the URL and "changes/"
if [[ "${GERRIT_URL}: -1}" != "/" ]]; then
  GERRIT_URL=${GERRIT_URL}/
fi
URL="${GERRIT_URL}changes/?q=${QUERY}&${QUERY_FIELDS}"

# `tail +2` is needed to remove a magic prefix (see https://gerrit-review.googlesource.com/Documentation/rest-api.html)
DATA=$(curl --netrc --request GET --url $URL --header 'Content-Type: application/json' | tail +2)

SEP='¤'
FIELDS='.subject, getpath(["revisions", .current_revision, "fetch","$CHECKOUT_METHOD", "commands", "Checkout"]), getpath(["revisions", .current_revision, "commit","message"])'

LIST=$(echo $DATA | jq -r "map([$FIELDS])|map(join(\"$SEP\"))|map(gsub(\"\n\";\"\t\"))|.[]")
SELECTED=$(echo "${LIST[@]}" | fzf -1 -0 -d "$SEP" --with-nth=1..-3 --preview 'echo {-1} | tr "\t" "\n"')
if [[ -z "$SELECTED" ]]; then
  exit 1
fi
CHECKOUT_NAME=$(echo $SELECTED | awk -F'¤' '{print $1}')
CHECKOUT_URL=$(echo $SELECTED | awk -F'¤' '{print $2}')

read -rp "Do you want to checkout \"$CHECKOUT_NAME\"? (y/n) " -n 1
echo #newline
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo $CHECKOUT_URL
fi
